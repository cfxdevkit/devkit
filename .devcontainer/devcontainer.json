// .devcontainer/devcontainer.json
// VS Code / GitHub Codespaces devcontainer for the cfxdevkit monorepo.
//
// Features:
//   • Node.js 22 + pnpm
//   • Biome, ESLint and TypeScript tooling pre-installed
//   • All workspace ports forwarded automatically
//   • `pnpm install` runs automatically after the container is created
{
  "name": "cfxdevkit monorepo",

  // Use the official Microsoft Node.js devcontainer image (Debian-based).
  "image": "mcr.microsoft.com/devcontainers/javascript-node:1-22-bookworm",

  // ── Features ─────────────────────────────────────────────────────────────
  "features": {
    // Enable corepack so `pnpm` is available without a global install.
    "ghcr.io/devcontainers/features/node:1": {
      "version": "22",
      "nodeGypDependencies": false
    }
  },

  // ── VS Code extensions ────────────────────────────────────────────────────
  "customizations": {
    "vscode": {
      "extensions": [
        "biomejs.biome",
        "dbaeumer.vscode-eslint",
        "ms-vscode.vscode-typescript-next",
        "esbenp.prettier-vscode",
        "ms-azuretools.vscode-docker",
        "redhat.vscode-yaml",
        "bradlc.vscode-tailwindcss",
        "streetsidesoftware.code-spell-checker"
      ],
      "settings": {
        // Use Biome as the default formatter for JavaScript / TypeScript.
        "editor.defaultFormatter": "biomejs.biome",
        "editor.formatOnSave": true,
        "[javascript]":  { "editor.defaultFormatter": "biomejs.biome" },
        "[typescript]":  { "editor.defaultFormatter": "biomejs.biome" },
        "[json]":        { "editor.defaultFormatter": "biomejs.biome" },
        "[jsonc]":       { "editor.defaultFormatter": "biomejs.biome" }
      }
    }
  },

  // ── Port forwarding ───────────────────────────────────────────────────────
  // Automatically forward the conflux-devkit UI and all RPC ports so you can
  // access them from your browser when running inside Codespaces.
  "forwardPorts": [7748, 8545, 8546, 12537, 12535],
  "portsAttributes": {
    "7748":  { "label": "conflux-devkit UI",           "onAutoForward": "openBrowser", "requireLocalPort": true },
    "8545":  { "label": "EVM RPC (HTTP)",               "onAutoForward": "silent",      "requireLocalPort": true },
    "8546":  { "label": "EVM RPC (WebSocket)",          "onAutoForward": "silent",      "requireLocalPort": true },
    "12537": { "label": "Conflux Core RPC (HTTP)",      "onAutoForward": "silent",      "requireLocalPort": true },
    "12535": { "label": "Conflux Core RPC (WebSocket)", "onAutoForward": "silent",      "requireLocalPort": true }
  },

  // ── Lifecycle hooks ───────────────────────────────────────────────────────
  "onCreateCommand": "corepack enable && corepack prepare pnpm@latest --activate",
  "postCreateCommand": "pnpm install",
  "postStartCommand": "pnpm build"
}
